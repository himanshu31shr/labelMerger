var _=Object.defineProperty;var $=(c,e,r)=>e in c?_(c,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):c[e]=r;var p=(c,e,r)=>$(c,typeof e!="symbol"?e+"":e,r);import{j as t,ar as j,a6 as w,ay as G,az as X,n as H,r as J,a7 as M,a1 as h,X as N,b as y,B as C,v as Q,ah as Y,z as Z,x as ee,C as te,D as se,G as re,al as oe,aA as ae,c as U,aB as ie,aC as ne,U as ce,aD as le,aE as O}from"./mui-vendor-tGclxw8b.js";import{a as S,i as de}from"./react-vendor-DYr15v6v.js";import{C as q,P as ue,u as he,a as R,n as pe,f as fe,o as xe}from"./index-Cb91SdTK.js";import{T as W}from"./firebase-vendor-yCdHbQaA.js";import{D as L}from"./DataTable-DEz7wYai.js";import{F as T}from"./FormattedCurrency-BQf40NSG.js";import{a as me,u as E}from"./utils-vendor-CFocuF-S.js";import"./redux-vendor-CLOwJCHO.js";import"./pdf-vendor-BVWGQTu2.js";class ge{constructor(e,r,o){p(this,"transactions");p(this,"productPrices");p(this,"costPriceService");p(this,"resolvedCostPrices",new Map);this.transactions=e.filter(s=>!!s&&!!s.type),this.productPrices=r,this.costPriceService=o||new q}isExpense(e){return e?["adjustment","refund","service fee","shipping services","returned","return_requested"].includes(e.toLowerCase()):!1}isSale(e){return e?["order","delivered","in_transit","return_cancelled"].includes(e.toLowerCase()):!1}async resolveCostPrices(){const e=new Map;this.transactions.forEach(o=>{e.has(o.sku)||e.set(o.sku,{sku:o.sku,categoryId:o.product.categoryId,customCostPrice:o.product.customCostPrice})});const r=Array.from(e.values());try{const o=await this.costPriceService.initializeCostPrices(r);this.resolvedCostPrices=o}catch(o){console.error("Error resolving cost prices:",o),r.forEach(s=>{this.resolvedCostPrices.set(s.sku,{value:0,source:"default",categoryId:null,sku:s.sku})})}}getResolvedCostPrice(e){var s;if(this.resolvedCostPrices.has(e))return this.resolvedCostPrices.get(e);const r=(s=this.productPrices)==null?void 0:s.get(e.toLowerCase());return{value:(r==null?void 0:r.costPrice)||0,source:"default",categoryId:null,sku:e}}async analyze(){var o;await this.resolveCostPrices();const e={totalSales:0,totalExpenses:0,expensesByCategory:{},salesByProduct:{},totalProfit:0,totalUnits:0,totalCost:0,profitBeforeCost:0,costPriceSources:{product:0,category:0,default:0},analyzedTransactions:[]},r=[];for(const s of this.transactions){const i=s.type||"",d=s.sku,a=s.quantity,n=s.sellingPrice,l=s.total||0,f=this.getResolvedCostPrice(d);if(s.product&&(s.product.resolvedCostPrice=f),r.push({...s}),this.isExpense(i)){const b=i==null?void 0:i.toLowerCase(),P=s.expenses.shippingFee+s.expenses.marketplaceFee+s.expenses.otherFees;e.expensesByCategory[b]=(e.expensesByCategory[b]||0)+P,e.totalExpenses+=P}if(this.isSale(i)){e.totalSales+=n;const b=s.expenses.shippingFee+s.expenses.marketplaceFee+s.expenses.otherFees;e.totalExpenses+=b;const P=f.value;if(e.costPriceSources&&f.source&&e.costPriceSources[f.source]++,!e.salesByProduct[d]){const v=(o=this.productPrices)==null?void 0:o.get(d.toLowerCase());e.salesByProduct[d]={units:0,amount:0,profit:0,profitPerUnit:0,name:(v==null?void 0:v.name)||d,costPriceSource:f.source}}const g=e.salesByProduct[d];g.units+=a,g.amount+=l,e.totalUnits+=a;const D=P*a;e.totalCost+=D;const I=l-D;g.profit+=I,g.units>0&&(g.profitPerUnit=g.profit/g.units),e.profitBeforeCost+=l,e.totalProfit+=I}}return e.analyzedTransactions=r,e}}const ye=({transactions:c})=>{const e=s=>`₹${s.toFixed(2)}`,r=c.map(s=>{var a,n;const i=((a=s.product.resolvedCostPrice)==null?void 0:a.value)||0,d=((n=s.product.resolvedCostPrice)==null?void 0:n.source)||"default";return{transactionId:s.transactionId||"",sku:s.sku||"",productName:s.product.name||s.description||"Unknown Product",platform:s.platform||"",sellingPrice:s.sellingPrice||0,total:s.total||0,productCost:i,costPriceSource:d,type:s.type||""}}),o=[{id:"transactionId",label:"#",filter:!0},{id:"sku",label:"SKU",filter:!0},{id:"productName",label:"Product Name",filter:!0},{id:"platform",label:"Platform",filter:!0},{id:"sellingPrice",label:"Selling Price",align:"right",filter:!0,format:s=>e(s)},{id:"total",label:"Earnings",align:"right",format:s=>e(s)},{id:"productCost",label:"Product Cost",align:"right",format:s=>e(s)},{id:"costPriceSource",label:"Price Source",filter:!0,format:s=>{const i=s;let d="inherit";return i==="product"&&(d="#1976d2"),i==="category"&&(d="#9c27b0"),t.jsx("span",{style:{fontWeight:i==="default"?"normal":"bold",color:d},children:i})}},{id:"type",label:"Type",filter:!0}];return t.jsx(L,{columns:o,data:r,defaultSortColumn:"transactionId",defaultSortDirection:"asc",rowsPerPageOptions:[15,30,50],defaultRowsPerPage:30})},be=({transactions:c,summary:e})=>{const r=a=>`₹${a.toFixed(2)}`,o=a=>{switch(a){case"product":return"success";case"category":return"primary";case"default":default:return"warning"}},s=a=>{switch(a){case"product":return"Custom cost price defined directly on the product";case"category":return"Cost price inherited from product category";case"default":default:return"Default cost price (no custom price or category price available)"}},i=S.useMemo(()=>{const a=new Map;return e?Object.entries(e.salesByProduct).forEach(([n,l])=>{a.set(n,{sku:n,description:l.description||l.name||n,units:l.units,sales:l.amount,cost:e.totalCost*(l.units/e.totalUnits),profit:l.profit,costPriceSource:l.costPriceSource})}):c.forEach(n=>{const l=n.sku,f=a.get(l)||{sku:l,description:n.description||l,units:0,sales:0,cost:0,profit:0};f.units+=n.quantity,f.sales+=n.sellingPrice*n.quantity;const b=n.product.customCostPrice||0;f.cost+=b*n.quantity;const P=n.expenses.shippingFee+n.expenses.marketplaceFee+n.expenses.otherFees,g=n.sellingPrice*n.quantity-b*n.quantity-P;f.profit+=g,a.set(l,f)}),Array.from(a.values())},[c,e]),d=[{id:"sku",label:"SKU",filter:!0},{id:"description",label:"Description",filter:!0},{id:"units",label:"Units",align:"right",format:a=>String(a)},{id:"sales",label:"Sales",align:"right",format:a=>r(a)},{id:"cost",label:"Cost",align:"right",format:a=>r(a)},{id:"profit",label:"Profit",align:"right",format:a=>r(a)},{id:"costPriceSource",label:"Price Source",format:a=>{const n=a||"default";return t.jsx(j,{title:s(n),children:t.jsx(w,{size:"small",label:n.charAt(0).toUpperCase()+n.slice(1),color:o(n),variant:"outlined"})})}}];return t.jsx(L,{columns:d,data:i,defaultSortColumn:"sku",defaultSortDirection:"asc",rowsPerPageOptions:[10,25,50],defaultRowsPerPage:25})},Pe=({summary:c})=>{const e=c.costPriceSources||{product:0,category:0,default:0},r=e.product+e.category+e.default,o=[{label:"Total Sales",value:t.jsx(T,{value:c.totalSales}),color:"primary",icon:t.jsx(G,{color:"primary",fontSize:"large"})},{label:"Total Expenses",value:t.jsx(T,{value:Math.abs(c.totalExpenses)}),color:"error",icon:t.jsx(X,{color:"error",fontSize:"large"})},{label:"Total Units Sold",value:c.totalUnits,color:"secondary",icon:t.jsx(H,{color:"secondary",fontSize:"large"})},{label:"Profit Before Cost",value:t.jsx(T,{value:c.profitBeforeCost}),color:"info",icon:t.jsx(J,{color:"info",fontSize:"large"})},{label:"Total Cost",value:t.jsx(T,{value:c.totalCost}),color:"success",icon:t.jsx(M,{color:"success",fontSize:"large"})},{label:"Total Profit",value:t.jsx(T,{value:c.totalProfit}),color:"success",icon:t.jsx(M,{color:"success",fontSize:"large"})}];return t.jsxs(h,{container:!0,spacing:2,children:[t.jsx(h,{item:!0,xs:12,children:t.jsx(h,{container:!0,spacing:2,children:o.map((s,i)=>t.jsx(h,{item:!0,xs:12,sm:6,md:4,lg:2,children:t.jsx(N,{sx:{p:2,textAlign:"center",borderLeft:"5px solid",borderColor:s.color,boxShadow:3,"flex-grow":1,width:"100%"},children:t.jsxs(h,{container:!0,spacing:2,alignItems:"center",justifyContent:"center",children:[t.jsx(h,{item:!0,md:3,children:s.icon}),t.jsxs(h,{item:!0,children:[t.jsx(y,{variant:"subtitle1",color:"textSecondary",children:s.label}),t.jsx(y,{variant:"h5",color:s.color,children:s.value})]})]})})},i))})}),t.jsx(h,{item:!0,xs:12,children:t.jsxs(N,{sx:{p:2,boxShadow:3},children:[t.jsxs(C,{sx:{display:"flex",alignItems:"center",mb:2},children:[t.jsx(Q,{color:"primary",sx:{mr:1}}),t.jsx(y,{variant:"h6",children:"Cost Price Sources"}),t.jsx(j,{title:"Shows how many products are using different cost price sources",children:t.jsx(Y,{fontSize:"small",sx:{ml:1,color:"text.secondary"}})})]}),t.jsxs(h,{container:!0,spacing:2,children:[t.jsx(h,{item:!0,children:t.jsx(j,{title:"Products with custom cost prices defined",children:t.jsx(w,{label:`Product: ${e.product}`,color:"success",sx:{fontWeight:"bold"}})})}),t.jsx(h,{item:!0,children:t.jsx(j,{title:"Products inheriting cost price from category",children:t.jsx(w,{label:`Category: ${e.category}`,color:"primary",sx:{fontWeight:"bold"}})})}),t.jsx(h,{item:!0,children:t.jsx(j,{title:"Products using default cost price (no custom or category price)",children:t.jsx(w,{label:`Default: ${e.default}`,color:"warning",sx:{fontWeight:"bold"}})})}),t.jsx(h,{item:!0,children:t.jsx(j,{title:"Total products analyzed",children:t.jsx(w,{label:`Total: ${r}`,variant:"outlined",sx:{fontWeight:"bold"}})})})]})]})})]})};class Ce{constructor(e){p(this,"file");p(this,"transactions",[]);p(this,"ordersData");this.file=e,this.rowToTransaction=this.rowToTransaction.bind(this),this.transformTransactions=this.transformTransactions.bind(this),this.parseCsvData=this.parseCsvData.bind(this),this.reponseAdapter=this.reponseAdapter.bind(this),this.process=this.process.bind(this)}parseCurrencyValue(e){if(!e)return 0;const r=e.replace(/[₹,\s]/g,"").trim(),o=parseFloat(r);return isNaN(o)?0:o}async parseCsvData(){this.ordersData=await new Promise((e,r)=>{ue.parse(this.file,{complete:e,header:!0,skipEmptyLines:!0,beforeFirstChunk:function(o){let i=o.indexOf(`
`);for(let d=1;d<11&&i>0;++d)i=o.indexOf(`
`,i+1);return o.substring(i+1)},error:r})})}transformTransactions(){if(!this.ordersData)throw new Error("No data to transform");this.transactions=this.ordersData.data.filter(e=>e&&typeof e=="object"&&e.type).map(this.rowToTransaction).filter(e=>!!e&&!!e.type&&!!e.sku)}rowToTransaction(e){var l;const r=e.Sku||e.sku||"",o=(l=e.type)==null?void 0:l.toLowerCase();if(!o||!["order","shipped","refund"].includes(o))return null;const s=this.parseCurrencyValue(e["product sales"]),i=this.parseCurrencyValue(e["selling fees"]),d=this.parseCurrencyValue(e["fba fees"]),a=this.parseCurrencyValue(e["other transaction fees"]),n=this.parseCurrencyValue(e.total);return{transactionId:e["order id"],platform:"amazon",orderDate:e["date/time"],sku:r,quantity:Number(e.quantity)||0,sellingPrice:s,description:e.description||"",type:o,marketplace:"Amazon",total:n,productSales:e["product sales"]||"0",sellingFees:Math.abs(i).toString(),fbaFees:Math.abs(d).toString(),otherTransactionFees:Math.abs(a).toString(),other:e.other||"0",expenses:{shippingFee:0,marketplaceFee:Math.abs(i),otherFees:Math.abs(d)+Math.abs(a)},product:{name:e.description||"",customCostPrice:null,sku:r,description:e.description||"",platform:"amazon",metadata:{},visibility:"visible",sellingPrice:s,inventory:{quantity:0,lowStockThreshold:5,lastUpdated:W.now()}},metadata:{createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},hash:Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}}reponseAdapter(){return this.transactions}async process(){return await this.parseCsvData(),this.transformTransactions(),this.reponseAdapter()}}class Se{constructor(e){p(this,"file");p(this,"workbook");p(this,"ordersData",[]);p(this,"transactions",[]);p(this,"categoryMapping",new Map);this.file=e,this.rowToTransaction=this.rowToTransaction.bind(this),this.transformOrdersData=this.transformOrdersData.bind(this),this.parseOrdersSheet=this.parseOrdersSheet.bind(this),this.readWorkbook=this.readWorkbook.bind(this),this.reponseAdapter=this.reponseAdapter.bind(this),this.process=this.process.bind(this),this.extractCategoryInfo=this.extractCategoryInfo.bind(this)}parseCurrencyValue(e){return e?typeof e=="number"?e:Number(e.replace(/[^\d.-]/g,""))||0:0}async readWorkbook(){try{const e=await this.file.arrayBuffer();this.workbook=me(e,{type:"array"});const r="Orders P&L";if(!this.workbook.SheetNames.includes(r))throw new Error("Required sheet 'Orders P&L' not found");const o=this.workbook.Sheets[r];if(!o||E.sheet_to_json(o).length===0)throw new Error("No data found in Orders P&L sheet");this.workbook.SheetNames.includes("Categories")&&await this.extractCategoryInfo()}catch(e){throw e instanceof Error?e:new Error("Failed to read workbook")}}async extractCategoryInfo(){if(!(!this.workbook||!this.workbook.SheetNames.includes("Categories")))try{const e=this.workbook.Sheets.Categories,r=E.sheet_to_json(e);r&&r.length>0&&r.forEach(o=>{o.SKU&&o.CategoryID&&this.categoryMapping.set(o.SKU,o.CategoryID)})}catch(e){console.error("Error extracting category information:",e)}}parseOrdersSheet(){var r;const e=(r=this.workbook)==null?void 0:r.Sheets["Orders P&L"];if(!e)throw new Error("Required sheet 'Orders P&L' not found");if(this.ordersData=E.sheet_to_json(e),!this.ordersData||this.ordersData.length===0)throw new Error("No data found in Orders P&L sheet")}transformOrdersData(){if(!this.ordersData)throw new Error("No orders data to transform");this.transactions=this.ordersData.map(this.rowToTransaction).filter(e=>!!e)}getCategoryId(e){if(e["SKU Name"]&&this.categoryMapping.has(e["SKU Name"]))return this.categoryMapping.get(e["SKU Name"]);if(e["Product Category"])return e["Product Category"]}rowToTransaction(e){if(!e["Order ID"])return null;const r=this.getCategoryId(e),o=this.parseCurrencyValue(e["Final Selling Price (incl. seller opted in default offers)"]);return{transactionId:e["Order ID"],sku:e["SKU Name"],description:e["SKU Name"],platform:"flipkart",marketplace:"Flipkart",type:"delivered",orderDate:e["Order Date"],quantity:e["Gross Units"],sellingPrice:o,orderStatus:e["Order Status"],total:this.parseCurrencyValue(e["Net Earnings (INR)"]),productSales:this.parseCurrencyValue(e["Accounted Net Sales (INR)"]),accNetSales:this.parseCurrencyValue(e["Bank Settlement [Projected] (INR)"]),expenses:{shippingFee:this.parseCurrencyValue(e["Shipping Fee (INR)"]),marketplaceFee:this.parseCurrencyValue(e["Commission (INR)"]),otherFees:this.parseCurrencyValue(e["Total Expenses (INR)"])},product:{name:e["SKU Name"]||"",sku:e["SKU Name"],description:e["SKU Name"]||"",platform:"flipkart",customCostPrice:null,categoryId:r,metadata:{lastImportedFrom:"flipkart",listingStatus:"active",moq:"1"},visibility:"visible",sellingPrice:o,inventory:{quantity:0,lowStockThreshold:5,lastUpdated:W.now()}},metadata:{createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},hash:Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}}reponseAdapter(){return this.transactions}async process(){return await this.readWorkbook(),this.parseOrdersSheet(),this.transformOrdersData(),this.reponseAdapter()}}class je{constructor(e){p(this,"reportType");p(this,"file");if(!e)throw new Error("No file selected!");this.file=e,this.identify()}identify(){var e;(e=this.file)!=null&&e.name.endsWith(".xlsx")?this.reportType="Flipkart":this.reportType="Amazon"}async extract(){if(!this.file)throw new Error("No file selected!");switch(this.reportType){case"Flipkart":return await new Se(this.file).process();case"Amazon":return await new Ce(this.file).process();default:throw new Error("Unsupported file type")}}}function B(c){const{children:e,value:r,index:o,...s}=c;return t.jsx("div",{hidden:r!==o,...s,children:r===o&&t.jsx(C,{sx:{p:0},children:e})})}const Me=()=>{var A,z;const c=he(),{items:e,loading:r,error:o}=R(x=>x.transactions),{items:s}=R(x=>x.products),[i,d]=S.useState(null),[a,n]=S.useState(0),[l,f]=S.useState({minDate:null,maxDate:null}),[b,P]=S.useState(!1),g=de();S.useEffect(()=>{(async()=>{try{await Promise.all([c(pe()),c(fe({}))])}catch{}})()},[c]),S.useEffect(()=>{(async()=>{if(e.length>0&&s.length>0)try{P(!0);const u=new Map(s.map(m=>[m.sku.toLowerCase(),m])),k=e.map(m=>({...m,product:{...m.product,...u.get(m.sku.toLowerCase())}})),F=k.map(m=>new Date(m.orderDate));f({minDate:new Date(Math.min(...F.map(m=>m.getTime()))),maxDate:new Date(Math.max(...F.map(m=>m.getTime())))});const V=new q,K=await new ge(k,u,V).analyze();d(K)}catch(u){console.error("Error analyzing transactions:",u)}finally{P(!1)}})()},[e,s]);const D=(x,u)=>{n(u)},I=S.useMemo(()=>{if(!e.length)return[];const x=new Map;return e.forEach(u=>{u.sku&&(x.has(u.sku)||x.set(u.sku,{sku:u.sku,description:u.description||u.sku}))}),Array.from(x.values())},[e]),v=async x=>{var u;try{const k=(u=x.target.files)==null?void 0:u[0];if(!k)throw new Error("No file selected");const F=await new je(k).extract();await c(xe(F)).unwrap(),x.target.value=""}catch{}};return t.jsx(Z,{maxWidth:"xl",sx:{py:3},children:t.jsxs(N,{sx:{p:3,mb:4,borderRadius:2},children:[t.jsxs(C,{sx:{display:"flex",alignItems:"center",mb:3},children:[t.jsx(ee,{sx:{fontSize:32,mr:2,color:"primary.main"}}),t.jsx(y,{variant:"h4",component:"h1",sx:{fontWeight:"bold",color:"primary.dark"},children:"Transaction Analytics"}),e.length>0&&t.jsx(w,{label:`${e.length} Transactions`,color:"primary",size:"medium",sx:{ml:2}}),t.jsx(C,{sx:{flexGrow:1}}),(r||b)&&t.jsxs(C,{sx:{display:"flex",alignItems:"center",mr:2},children:[t.jsx(te,{size:24,sx:{mr:1},color:"primary"}),t.jsx(y,{color:"primary.main",children:r?"Processing...":"Analyzing prices..."})]})]}),t.jsx(se,{sx:{mb:3}}),t.jsx(re,{sx:{mb:3,borderRadius:2,border:"1px solid",borderColor:l.minDate?"info.light":"divider"},children:t.jsxs(oe,{children:[t.jsxs(C,{sx:{display:"flex",alignItems:"center",mb:2},children:[t.jsx(ae,{sx:{color:"info.main",mr:1}}),t.jsx(y,{variant:"h6",sx:{fontWeight:"bold",color:"info.dark"},children:l.minDate?t.jsx(t.Fragment,{children:"Transaction Period"}):t.jsx(t.Fragment,{children:"No Transactions Available"})})]}),l.minDate?t.jsxs(y,{variant:"body1",children:["Analyzing transactions from ",t.jsx("strong",{children:(A=l.minDate)==null?void 0:A.toDateString()})," to ",t.jsx("strong",{children:(z=l.maxDate)==null?void 0:z.toDateString()})]}):t.jsx(y,{variant:"body1",color:"text.secondary",children:"Upload a transaction file to begin analysis"})]})}),t.jsxs(h,{container:!0,spacing:2,sx:{mb:3},children:[t.jsx(h,{item:!0,xs:12,sm:6,children:t.jsxs(U,{variant:"contained",component:"label",disabled:r,startIcon:t.jsx(ie,{}),fullWidth:!0,sx:{py:1.5,fontWeight:"medium"},children:["Upload Transaction File",t.jsx("input",{type:"file",hidden:!0,accept:".csv,.xlsx",onChange:v})]})}),t.jsx(h,{item:!0,xs:12,sm:6,children:t.jsx(U,{variant:"contained",color:"secondary",onClick:()=>g("/flipkart-amazon-tools/products"),disabled:!I.length,startIcon:t.jsx(ne,{}),fullWidth:!0,sx:{py:1.5,fontWeight:"medium"},children:"Manage Product Prices"})})]}),o&&t.jsx(ce,{severity:"error",sx:{mb:3},children:o}),i&&t.jsxs(t.Fragment,{children:[t.jsx(Pe,{summary:i}),t.jsx(C,{sx:{mt:4,mb:2},children:t.jsx(C,{sx:{borderBottom:1,borderColor:"divider"},children:t.jsxs(le,{value:a,onChange:D,sx:{"& .MuiTab-root":{fontWeight:"bold"},"& .Mui-selected":{color:"primary.main"},"& .MuiTabs-indicator":{backgroundColor:"primary.main"}},children:[t.jsx(O,{label:"Orders"}),t.jsx(O,{label:"Product Details"})]})})}),t.jsx(B,{value:a,index:0,children:t.jsx(ye,{transactions:(i==null?void 0:i.analyzedTransactions)||[]})}),t.jsx(B,{value:a,index:1,children:t.jsx(be,{transactions:e,summary:i})})]}),!i&&!r&&t.jsxs(C,{sx:{textAlign:"center",py:5},children:[t.jsx(y,{variant:"h6",color:"text.secondary",gutterBottom:!0,children:"No transaction data available"}),t.jsx(y,{variant:"body1",color:"text.secondary",children:"Upload a transaction file to view analytics"})]})]})})};export{Me as TransactionAnalytics};
